import{r as n,j as e,d as K,L as Y,e as U}from"./index-yZ_RLkP0.js";import{S as V}from"./search-BJeNHSDh.js";import{P as X}from"./plus-BFfVhgJW.js";import{P as Z}from"./play-B7Ir4mti.js";import{T}from"./trash-2-KdDYK25i.js";const q="_container_crzy2_1",ee="_header_crzy2_10",te="_toolbar_crzy2_26",se="_searchWrap_crzy2_32",re="_searchIcon_crzy2_37",ae="_searchInput_crzy2_45",ne="_btn_crzy2_61",ce="_btnSecondary_crzy2_88",oe="_formCard_crzy2_109",le="_formRow_crzy2_119",ie="_formActions_crzy2_124",de="_input_crzy2_129",ue="_select_crzy2_145",me="_textarea_crzy2_160",_e="_empty_crzy2_177",ye="_table_crzy2_188",he="_tableHeader_crzy2_194",pe="_tableRow_crzy2_208",xe="_cellName_crzy2_227",fe="_cellQuery_crzy2_236",ge="_cellDate_crzy2_245",je="_cellActions_crzy2_251",Ne="_iconBtn_crzy2_257",be="_iconBtnDanger_crzy2_282",Se="_tag_crzy2_300",ze="_tagAnalysis_crzy2_309",Ce="_tagSQL_crzy2_315",ve="_tagReport_crzy2_321",we="_tagCustom_crzy2_327",Qe="_copiedToast_crzy2_333",Re="_resultInline_crzy2_346",Ae="_resultPre_crzy2_355",Ie="_spin_crzy2_365",s={container:q,header:ee,toolbar:te,searchWrap:se,searchIcon:re,searchInput:ae,btn:ne,btnSecondary:ce,formCard:oe,formRow:le,formActions:ie,input:de,select:ue,textarea:me,empty:_e,table:ye,tableHeader:he,tableRow:pe,cellName:xe,cellQuery:fe,cellDate:ge,cellActions:je,iconBtn:Ne,iconBtnDanger:be,tag:Se,tagAnalysis:ze,tagSQL:Ce,tagReport:ve,tagCustom:we,copiedToast:Qe,resultInline:Re,resultPre:Ae,spin:Ie},B="klaus_saved_queries",ke=["Analysis","SQL","Report","Custom"];function De(){try{return JSON.parse(localStorage.getItem(B)||"[]")}catch{return[]}}function Ee(y){localStorage.setItem(B,JSON.stringify(y))}function Fe({apiUrl:y}){const[l,j]=n.useState(De),[N,L]=n.useState(""),[b,h]=n.useState(!1),[i,S]=n.useState(""),[d,z]=n.useState(""),[C,v]=n.useState("Custom"),[p,w]=n.useState(null),[Q,c]=n.useState({}),[O,x]=n.useState(null),[P,R]=n.useState(null),A=n.useRef(null),F={"Content-Type":"application/json","ngrok-skip-browser-warning":"true"};n.useEffect(()=>{Ee(l)},[l]);const I=l.filter(t=>{const a=N.toLowerCase();return!a||t.name.toLowerCase().includes(a)||t.query.toLowerCase().includes(a)||t.category.toLowerCase().includes(a)}),$=()=>{if(!i.trim()||!d.trim())return;const t={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),name:i.trim(),query:d.trim(),category:C,createdAt:new Date().toISOString()};j(a=>[t,...a]),S(""),z(""),v("Custom"),h(!1)},J=t=>{j(a=>a.filter(r=>r.id!==t)),x(null),c(a=>{const r={...a};return delete r[t],r})},W=async(t,a)=>{await navigator.clipboard.writeText(a),R(t),setTimeout(()=>R(null),1500)},H=async t=>{p&&A.current?.abort();const a=new AbortController;A.current=a,w(t.id),c(r=>({...r,[t.id]:""}));try{const r=await fetch(`${y}/klaus/imi/chat`,{method:"POST",headers:F,body:JSON.stringify({message:t.query,history:[]}),signal:a.signal});if(!r.ok)throw new Error(`${r.status} ${r.statusText}`);const u=r.body?.getReader();if(!u)throw new Error("No response body");const f=new TextDecoder;let o="",m="";for(;;){const{done:_,value:g}=await u.read();if(_)break;o+=f.decode(g,{stream:!0});const k=o.split(`
`);o=k.pop()||"";for(const G of k){const D=G.trim();if(D)try{const E=JSON.parse(D);E.content&&(m+=E.content,c(M=>({...M,[t.id]:m})))}catch{}}}if(o.trim())try{const _=JSON.parse(o.trim());_.content&&(m+=_.content,c(g=>({...g,[t.id]:m})))}catch{}}catch(r){if(r instanceof DOMException&&r.name==="AbortError")return;const u=r instanceof Error?r.message:"Request failed";c(f=>({...f,[t.id]:`Error: ${u}`}))}finally{w(null)}};return e.jsxs("div",{className:s.container,children:[e.jsxs("div",{className:s.header,children:[e.jsxs("h1",{children:[e.jsx(K,{size:20})," Saved Queries"]}),e.jsx("p",{children:"Save, organize, and re-run your favorite queries"})]}),e.jsxs("div",{className:s.toolbar,children:[e.jsxs("div",{className:s.searchWrap,children:[e.jsx(V,{size:14,className:s.searchIcon}),e.jsx("input",{className:s.searchInput,placeholder:"Filter saved queries...",value:N,onChange:t=>L(t.target.value)})]}),e.jsxs("button",{className:s.btn,onClick:()=>h(!b),children:[e.jsx(X,{size:14}),"Save New Query"]})]}),b&&e.jsxs("div",{className:s.formCard,children:[e.jsxs("div",{className:s.formRow,children:[e.jsx("input",{className:s.input,placeholder:"Query name",value:i,onChange:t=>S(t.target.value)}),e.jsx("select",{className:s.select,value:C,onChange:t=>v(t.target.value),children:ke.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsx("textarea",{className:s.textarea,placeholder:"Enter your query...",value:d,onChange:t=>z(t.target.value),rows:3}),e.jsxs("div",{className:s.formActions,children:[e.jsx("button",{className:s.btn,onClick:$,disabled:!i.trim()||!d.trim(),children:"Save"}),e.jsx("button",{className:s.btnSecondary,onClick:()=>h(!1),children:"Cancel"})]})]}),I.length===0?e.jsx("div",{className:s.empty,children:l.length===0?'No saved queries yet. Click "Save New Query" to get started.':"No queries match your filter."}):e.jsxs("div",{className:s.table,children:[e.jsxs("div",{className:s.tableHeader,children:[e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Query"}),e.jsx("span",{children:"Category"}),e.jsx("span",{children:"Saved"}),e.jsx("span",{children:"Actions"})]}),I.map(t=>e.jsxs("div",{className:s.tableRow,children:[e.jsx("span",{className:s.cellName,children:t.name}),e.jsx("span",{className:s.cellQuery,children:t.query}),e.jsx("span",{children:e.jsx("span",{className:`${s.tag} ${s[`tag${t.category}`]}`,children:t.category})}),e.jsx("span",{className:s.cellDate,children:new Date(t.createdAt).toLocaleDateString()}),e.jsxs("span",{className:s.cellActions,children:[e.jsx("button",{className:s.iconBtn,title:"Run query",onClick:()=>H(t),disabled:p===t.id,children:p===t.id?e.jsx(Y,{size:14,className:s.spin}):e.jsx(Z,{size:14})}),e.jsxs("button",{className:s.iconBtn,title:"Copy query",onClick:()=>W(t.id,t.query),children:[e.jsx(U,{size:14}),P===t.id&&e.jsx("span",{className:s.copiedToast,children:"Copied"})]}),O===t.id?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:s.iconBtnDanger,title:"Confirm delete",onClick:()=>J(t.id),children:e.jsx(T,{size:14})}),e.jsx("button",{className:s.iconBtn,title:"Cancel",onClick:()=>x(null),style:{fontSize:11},children:"esc"})]}):e.jsx("button",{className:s.iconBtn,title:"Delete",onClick:()=>x(t.id),children:e.jsx(T,{size:14})})]}),Q[t.id]!==void 0&&e.jsx("div",{className:s.resultInline,children:e.jsx("pre",{className:s.resultPre,children:Q[t.id]||"Waiting for response..."})})]},t.id))]})]})}export{Fe as default};
